import { Router, Request, Response } from "express"
import { AnimalService } from "../services/animalservice" 
import { authMiddleware, requireAdmin } from "../middleware/authmiddleware"
import { PrismaClient } from "@prisma/client"

const prisma = new PrismaClient()
const router = Router()


// Interfaces pour typer les donnÃ©es reÃ§ues dans les requÃªtes 
interface CreateAnimalRequest {
    type: string 
    name: string 
    city: string
    age: number
    breed: string
    description?: string
}

interface UpdateAnimalRequest {
    type?: string
    name?: string
    city?: string
    age?: number
    breed?: string
    description?: string
    status?: string
}

interface SearchAnimalRequest {
    type?: string
    city?: string
    breed?: string
    minAge?: string
    maxAge?: string
    status?: string
}

interface CreateAdoptionRequest {
    animalId: number
    firstname: string
    lastname: string
    phone: string
}

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E UTILISATEUR - CrÃ©er une demande d'adoption
ResponsabilitÃ© : Permettre Ã  un utilisateur connectÃ© de faire une demande d'adoption
Validation des donnÃ©es + vÃ©rification que l'animal est disponible*/

router.post('/adoptions', authMiddleware, async (req: Request, res: Response) => {
    try {
        const userId = req.user!.userId 
        const { animalId, firstname, lastname, phone } = req.body as CreateAdoptionRequest 

        // Validation des champs obligatoires 
        if (!animalId || !firstname || !lastname || !phone) {
            return res.status(400).json({
                success: false,
                message: 'Tous les champs sont requis (animalId, firstname, lastname, phone)'
            })
        }

        // VÃ©rifier que l'animal existe et est dispo 
        const animal = await prisma.animal.findUnique({
            where: { id: animalId }
        })

        if (!animal) {
            return res.status(404).json({
                success: false, 
                message: 'Animal non trouvÃ©'
            })
        }

        if (animal.status !== 'available') {
            return res.status(400).json({
                success: false,
                message: 'Cet animal n\'est plus disponible Ã  l\'adoption'
            })
        }

        // VÃ©rifier que l'utilisateur n'a pas dÃ©jÃ  fait une demande pour cet animal 
        const existingAdoption = await prisma.adopt.findFirst({
            where: {
                userid: userId,
                animalid: animalId, 
                status: {
                    in: ['pending', 'approved']
                }
            }
        })

        if (existingAdoption) {
            return res.status(409).json({
                succes: false, 
                message: 'Vous avez dÃ©jÃ  une demande d\'adoption en cours pour cet animal'
            })
        }

        //CrÃ©er la demande d'adoption 
        const adoption = await prisma.adopt.create({
            data: {
                userid: userId,
                animalid: animalId,
                firstname: firstname.trim(),
                lastname: lastname.trim(),
                phone: phone.trim(),
                status: 'pending'
            },
            include: {
                animal: {
                    select: {
                        id: true,
                        name: true,
                        type: true,
                        breed: true,
                        age: true,
                        city: true 

                    }
                }
            }
        })

        res.status(201).json({
            success: true, 
            message: 'Demande d\'adoption crÃ©Ã©e avec succcÃ¨s', 
            data: adoption
        })
    } catch (error) {
        console.error('Erreur lors de la crÃ©ation de la demande d\'adoption:', error)

        res.status(500).json({
            success: true,
            message: 'Erreur lors de la crÃ©ation de la demande d\'adoption', 
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})


/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E UTILISATEUR - Mes demandes d'adoption
ResponsabilitÃ© : RÃ©cupÃ©rer toutes les demandes d'adoption de l'utilisateur connectÃ©
Avec les dÃ©tails des animaux concernÃ©s et le statut des demandes*/

router.get('/my-adoption', authMiddleware, async (req: Request, res: Response) => {
    try {
        const userId = req.user!.userId

        const adoptions = await prisma.adopt.findMany({
            where: {userid: userId },
            include: {
                animal: {
                    select: {
                        id: true,
                        name: true,
                        type: true,
                        breed: true,
                        age: true,
                        city: true,
                        description: true,
                        status: true
                    }
                }
            },
            orderBy: {
                createdAt: 'desc'
            }
        })

        res.json({
            success: true,
            message: 'Vos demandes d\'adoption rÃ©cupÃ©rÃ©es avec succÃ¨s',
            data: adoptions
        })
    } catch (error) {
        console.error('Erreur lors de la rÃ©cupÃ©ration des adoptions:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la rÃ©cupÃ©ration de vos demandes d\'adoption',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E UTILISATEUR - Annuler une demande d'adoption
ResponsabilitÃ© : Permettre Ã  un utilisateur d'annuler sa propre demande d'adoption
Uniquement si elle est encore en statut "pending"*/

router.delete('/adoption/:id', authMiddleware, async (req: Request, res: Response) => {
    try {
        const userId = req.user!.userId
        const adoptionId = parseInt(req.params.id)

        if (isNaN(adoptionId)) {
            return res.status(400).json({
                success: false, 
                message: 'ID de demande d\'adoption invalide' 
            })
        }

        // VÃ©rifier que la demande existe et appartient Ã  l'utilisateur 
        const adoption = await prisma.adopt.findUnique({
            where: { id: adoptionId }
        })

        if (!adoption) {
            return res.status(404).json({
                success: false,
                message: 'Demande d\'adoption non trouvÃ©e'
            })
        }

        if (adoption.userid !== userId) {
            return res.status(403).json({
                success: false, 
                message: 'Vous ne pouvez annulez que vos propres d\'adoption'
            })
        }
        if (adoption.status !== 'pending') {
            return res.status(400).json({
                success: false,
                message: 'Vous ne pouvez annuler que les demandes en attente'
            })
        }

        // Supprimer la demande d'adoption
        await prisma.adopt.delete({
            where: { id: adoptionId }
        })

        res.json({
            success: true, 
            message: 'Demande d\'adoption annulÃ©e avec succÃ¨s'
        })
    } catch (error) {
        console.error('Erreur lors de l\'annulation de la demande d\'adoption:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de l\'annulation de la demande d\'adoption', 
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined 
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E UTILISATEUR - DÃ©tail d'une demande d'adoption
ResponsabilitÃ© : RÃ©cupÃ©rer les dÃ©tails d'une demande d'adoption spÃ©cifique
Uniquement accessible par le propriÃ©taire de la demande*/

router.get('/adoptions/:id', authMiddleware, async (req: Request, res: Response) => {
    try {
        const userId = req.user!.userId 
        const adoptionId = parseInt(req.params.id) 

        if (isNaN(adoptionId)) {
            return res.status(400).json({
                success: false,
                message: 'ID de demande d\'adoption invalide'
            })
        }

          const adoption = await prisma.adopt.findUnique({
            where: { id: adoptionId },
            include: {
                animal: {
                    select: {
                        id: true,
                        name: true,
                        type: true,
                        breed: true,
                        age: true,
                        city: true,
                        description: true,
                        status: true
                    }
                }
            }
        })

        if (!adoption) {
            return res.status(404).json({
                success: false,
                message: 'Demande d\'adoption non trouvÃ©e'
            })
        }

        if (adoption.userid !== userId) {
            return res.status(403).json({
                success: false,
                message: 'Vous ne pouvez consulter que vos propres demandes d\'adoption'
            })
        }

        res.json({
            success: true,
            data: adoption
        })

    } catch (error) {
        console.error('Erreur lors de la rÃ©cupÃ©ration de la demande d\'adoption:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la rÃ©cupÃ©ration de la demande d\'adoption',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

 /* ------------------------ ROUTES PUBLIQUES (Vue utilisateur)----------------------------
ResponsabilitÃ© : RÃ©cupÃ©rer et retourner la liste des animaux disponibles Ã  l'adoption
UtilisÃ©e pour alimenter la page d'adoption avec les vignettes d'animaux
*/
router.get('/animals', async (req: Request, res: Response) => {
    try {
        const animals = await AnimalService.getAvailableAnimals()

        res.json({
            success: true,
            message: 'Liste des animaux disponibles rÃ©cupÃ©rÃ©e avec succÃ¨s',
            data: animals
        })

    } catch (error) {
        console.error('Erreur lors de la rÃ©cupÃ©ration des animaux:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la rÃ©cupÃ©ration des animaux',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸŸ¢ ROUTE PUBLIQUE - Rechercher des animaux avec filtres
ResponsabilitÃ© : Permettre la recherche d'animaux selon diffÃ©rents critÃ¨res
GÃ¨re les paramÃ¨tres de recherche envoyÃ©s via query string
*/
router.get('/animals/search', async (req: Request, res: Response) => {
    try {
        const { type, city, breed, minAge, maxAge, status } = req.query as SearchAnimalRequest

        // Validation et conversion des paramÃ¨tres
        const filters: any = {}

        if (type) filters.type = type
        if (city) filters.city = city
        if (breed) filters.breed = breed
        if (status) filters.status = status

        // Conversion des Ã¢ges en nombres si fournis
        if (minAge) {
            const minAgeNum = parseInt(minAge)
            if (isNaN(minAgeNum) || minAgeNum < 0) {
                return res.status(400).json({
                    success: false,
                    message: 'L\'Ã¢ge minimum doit Ãªtre un nombre positif'
                })
            }
            filters.minAge = minAgeNum
        }

        if (maxAge) {
            const maxAgeNum = parseInt(maxAge)
            if (isNaN(maxAgeNum) || maxAgeNum < 0) {
                return res.status(400).json({
                    success: false,
                    message: 'L\'Ã¢ge maximum doit Ãªtre un nombre positif'
                })
            }
            filters.maxAge = maxAgeNum
        }

        // VÃ©rifier la cohÃ©rence des Ã¢ges
        if (filters.minAge && filters.maxAge && filters.minAge > filters.maxAge) {
            return res.status(400).json({
                success: false,
                message: 'L\'Ã¢ge minimum ne peut pas Ãªtre supÃ©rieur Ã  l\'Ã¢ge maximum'
            })
        }

        const animals = await AnimalService.searchAnimals(filters)

        res.json({
            success: true,
            message: `${animals.length} animal(s) trouvÃ©(s)`,
            data: animals,
            filters: filters // Retourner les filtres appliquÃ©s pour info
        })

    } catch (error) {
        console.error('Erreur lors de la recherche d\'animaux:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la recherche d\'animaux',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸŸ¢ ROUTE PUBLIQUE - RÃ©cupÃ©rer un animal par son ID
ResponsabilitÃ© : Afficher les dÃ©tails complets d'un animal spÃ©cifique
UtilisÃ©e pour la page de dÃ©tail d'un animal avant adoption
*/
router.get('/animals/:id', async (req: Request, res: Response) => {
    try {
        const animalId = parseInt(req.params.id)

        if (isNaN(animalId)) {
            return res.status(400).json({
                success: false,
                message: 'ID d\'animal invalide'
            })
        }

        const animal = await AnimalService.getAnimalById(animalId)

        res.json({
            success: true,
            data: animal
        })

    } catch (error) {
        console.error('Erreur lors de la rÃ©cupÃ©ration de l\'animal:', error)

        if (error instanceof Error && error.message === 'Animal non trouvÃ©') {
            return res.status(404).json({
                success: false,
                message: error.message
            })
        }

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la rÃ©cupÃ©ration de l\'animal',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - CrÃ©er un nouvel animal
ResponsabilitÃ© : Permettre aux administrateurs d'ajouter des animaux dans le systÃ¨me
Validation des donnÃ©es d'entrÃ©e + dÃ©lÃ©gation au service
*/
router.post('/animals', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const { type, name, city, age, breed, description } = req.body as CreateAnimalRequest

        // Validation des champs obligatoires
        if (!type || !name || !city || !breed) {
            return res.status(400).json({
                success: false,
                message: 'Tous les champs obligatoires doivent Ãªtre renseignÃ©s (type, name, city, breed)'
            })
        }

        // Validation de l'Ã¢ge
        if (age === undefined || age === null) {
            return res.status(400).json({
                success: false,
                message: 'L\'Ã¢ge de l\'animal est obligatoire'
            })
        }

        // Validation avec les mÃ©thodes centralisÃ©es du service
        const nameValidation = AnimalService.isValidAnimalName(name)
        if (!nameValidation.valid) {
            return res.status(400).json({
                success: false,
                message: nameValidation.message
            })
        }

        const ageValidation = AnimalService.isValidAge(age)
        if (!ageValidation.valid) {
            return res.status(400).json({
                success: false,
                message: ageValidation.message
            })
        }

        // DÃ©lÃ©gation de toute la logique mÃ©tier au service
        const animal = await AnimalService.createAnimal({
            type: type.trim(),
            name: name.trim(),
            city: city.trim(),
            age,
            breed: breed.trim(),
            description: description?.trim()
        })

        res.status(201).json({
            success: true,
            message: 'Animal crÃ©Ã© avec succÃ¨s',
            data: animal
        })

    } catch (error) {
        console.error('Erreur lors de la crÃ©ation de l\'animal:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la crÃ©ation de l\'animal',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Modifier un animal
ResponsabilitÃ© : Permettre aux administrateurs de mettre Ã  jour les informations d'un animal
Validation des donnÃ©es + gestion des erreurs mÃ©tier
*/
router.put('/animals/:id', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const animalId = parseInt(req.params.id)
        const { type, name, city, age, breed, description, status } = req.body as UpdateAnimalRequest

        if (isNaN(animalId)) {
            return res.status(400).json({
                success: false,
                message: 'ID d\'animal invalide'
            })
        }

        // VÃ©rifier qu'au moins un champ est fourni pour la mise Ã  jour
        if (!type && !name && !city && age === undefined && !breed && !description && !status) {
            return res.status(400).json({
                success: false,
                message: 'Vous devez fournir au moins un champ Ã  mettre Ã  jour'
            })
        }

        // Validation des champs modifiÃ©s
        if (name && !AnimalService.isValidAnimalName(name).valid) {
            return res.status(400).json({
                success: false,
                message: AnimalService.isValidAnimalName(name).message
            })
        }

        if (age !== undefined && !AnimalService.isValidAge(age).valid) {
            return res.status(400).json({
                success: false,
                message: AnimalService.isValidAge(age).message
            })
        }

        // DÃ©lÃ©gation au service
        const updatedAnimal = await AnimalService.updateAnimal(animalId, {
            type,
            name,
            city,
            age,
            breed,
            description,
            status
        })

        res.json({
            success: true,
            message: 'Animal mis Ã  jour avec succÃ¨s',
            data: updatedAnimal
        })

    } catch (error) {
        console.error('Erreur lors de la mise Ã  jour de l\'animal:', error)

        if (error instanceof Error) {
            if (error.message === 'Animal non trouvÃ©') {
                return res.status(404).json({
                    success: false,
                    message: error.message
                })
            }
            if (error.message.includes('Statut invalide')) {
                return res.status(400).json({
                    success: false,
                    message: error.message
                })
            }
        }

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la mise Ã  jour de l\'animal',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Supprimer un animal
ResponsabilitÃ© : Permettre aux administrateurs de supprimer un animal du systÃ¨me
Avec vÃ©rifications de sÃ©curitÃ© (pas d'adoptions en cours)
*/
router.delete('/animals/:id', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const animalId = parseInt(req.params.id)

        if (isNaN(animalId)) {
            return res.status(400).json({
                success: false,
                message: 'ID d\'animal invalide'
            })
        }

        const result = await AnimalService.deleteAnimal(animalId)

        res.json({
            success: true,
            message: result.message
        })

    } catch (error) {
        console.error('Erreur lors de la suppression de l\'animal:', error)

        if (error instanceof Error) {
            if (error.message === 'Animal non trouvÃ©') {
                return res.status(404).json({
                    success: false,
                    message: error.message
                })
            }
            if (error.message.includes('demandes d\'adoption en cours')) {
                return res.status(409).json({
                    success: false,
                    message: error.message
                })
            }
        }

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la suppression de l\'animal',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Marquer comme adoptÃ©
ResponsabilitÃ© : Changer le statut d'un animal vers "adoptÃ©"
UtilisÃ©e quand une adoption est finalisÃ©e
*/
router.patch('/animals/:id/adopt', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const animalId = parseInt(req.params.id)

        if (isNaN(animalId)) {
            return res.status(400).json({
                success: false,
                message: 'ID d\'animal invalide'
            })
        }

        const animal = await AnimalService.markAsAdopted(animalId)

        res.json({
            success: true,
            message: 'Animal marquÃ© comme adoptÃ© avec succÃ¨s',
            data: animal
        })

    } catch (error) {
        console.error('Erreur lors du marquage comme adoptÃ©:', error)

        if (error instanceof Error) {
            if (error.message === 'Animal non trouvÃ©') {
                return res.status(404).json({
                    success: false,
                    message: error.message
                })
            }
            if (error.message.includes('dÃ©jÃ  adoptÃ©')) {
                return res.status(400).json({
                    success: false,
                    message: error.message
                })
            }
        }

        res.status(500).json({
            success: false,
            message: 'Erreur lors du marquage comme adoptÃ©',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Remettre comme disponible
ResponsabilitÃ© : Changer le statut d'un animal vers "available"
UtilisÃ©e si une adoption n'aboutit pas
*/
router.patch('/animals/:id/available', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const animalId = parseInt(req.params.id)

        if (isNaN(animalId)) {
            return res.status(400).json({
                success: false,
                message: 'ID d\'animal invalide'
            })
        }

        const animal = await AnimalService.markAsAvailable(animalId)

        res.json({
            success: true,
            message: 'Animal remis comme disponible avec succÃ¨s',
            data: animal
        })

    } catch (error) {
        console.error('Erreur lors de la remise en disponibilitÃ©:', error)

        if (error instanceof Error && error.message === 'Animal non trouvÃ©') {
            return res.status(404).json({
                success: false,
                message: error.message
            })
        }

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la remise en disponibilitÃ©',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Statistiques des animaux
ResponsabilitÃ© : Fournir un dashboard avec les statistiques globales
UtilisÃ©e pour les tableaux de bord administrateur
*/
router.get('/admin/stats', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const stats = await AnimalService.getAnimalStats()

        res.json({
            success: true,
            message: 'Statistiques rÃ©cupÃ©rÃ©es avec succÃ¨s',
            data: stats
        })

    } catch (error) {
        console.error('Erreur lors de la rÃ©cupÃ©ration des statistiques:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la rÃ©cupÃ©ration des statistiques',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Tous les animaux (y compris adoptÃ©s)
ResponsabilitÃ© : Lister tous les animaux pour l'administration
Avec les informations d'adoption si applicable
*/
router.get('/admin/animals', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const animals = await AnimalService.getAllAnimals()

        res.json({
            success: true,
            message: 'Liste complÃ¨te des animaux rÃ©cupÃ©rÃ©e avec succÃ¨s',
            data: animals
        })

    } catch (error) {
        console.error('Erreur lors de la rÃ©cupÃ©ration de tous les animaux:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la rÃ©cupÃ©ration des animaux',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - RÃ©cupÃ©rer toutes les demandes d'adoption
ResponsabilitÃ© : Permettre aux administrateurs de voir toutes les demandes d'adoption
Avec filtrage par statut et informations complÃ¨tes utilisateur + animal*/

router.get('/admin/adoptions', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const { status } = req.query

        // Construire les conditions de filtrage
        const whereConditions: any = {}
        
        if (status && status !== 'all') {
            whereConditions.status = status
        }

        const adoptions = await prisma.adopt.findMany({
            where: whereConditions,
            include: {
                users: {
                    select: {
                        id: true,
                        firstname: true,
                        lastname: true,
                        email: true,
                        phone: true,
                        createdAt: true
                    }
                },
                animal: {
                    select: {
                        id: true,
                        name: true,
                        type: true,
                        breed: true,
                        age: true,
                        city: true,
                        description: true,
                        status: true
                    }
                }
            },
            orderBy: {
                createdAt: 'desc'
            }
        })

        res.json({
            success: true,
            message: 'Demandes d\'adoption rÃ©cupÃ©rÃ©es avec succÃ¨s',
            data: adoptions
        })

    } catch (error) {
        console.error('Erreur lors de la rÃ©cupÃ©ration des adoptions admin:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la rÃ©cupÃ©ration des demandes d\'adoption',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Approuver/Rejeter une demande d'adoption
ResponsabilitÃ© : Permettre aux administrateurs de modÃ©rer les demandes d'adoption
Change le statut de la demande ET de l'animal si approuvÃ©*/

router.put('/admin/adoptions/:id', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const adoptionId = parseInt(req.params.id)
        const { status, adminComment } = req.body

        if (isNaN(adoptionId)) {
            return res.status(400).json({
                success: false,
                message: 'ID de demande d\'adoption invalide'
            })
        }

        // VÃ©rifier les statuts valides
        if (!['pending', 'approved', 'rejected'].includes(status)) {
            return res.status(400).json({
                success: false,
                message: 'Statut invalide. Statuts autorisÃ©s: pending, approved, rejected'
            })
        }

        // VÃ©rifier que la demande existe
        const existingAdoption = await prisma.adopt.findUnique({
            where: { id: adoptionId },
            include: {
                animal: true,
                users: {
                    select: {
                        firstname: true,
                        lastname: true,
                        email: true
                    }
                }
            }
        })

        if (!existingAdoption) {
            return res.status(404).json({
                success: false,
                message: 'Demande d\'adoption non trouvÃ©e'
            })
        }

        // Transaction pour mettre Ã  jour Ã  la fois l'adoption et l'animal
        const result = await prisma.$transaction(async (tx) => {
            // Mettre Ã  jour la demande d'adoption
            const updatedAdoption = await tx.adopt.update({
                where: { id: adoptionId },
                data: {
                    status: status,
                    user: adminComment || null // Stocker le commentaire admin dans le champ user temporairement
                },
                include: {
                    users: {
                        select: {
                            id: true,
                            firstname: true,
                            lastname: true,
                            email: true
                        }
                    },
                    animal: true
                }
            })

            // Si approuvÃ©, marquer l'animal comme adoptÃ© et rejeter les autres demandes pour cet animal
            if (status === 'approved') {
                // Marquer l'animal comme adoptÃ©
                await tx.animal.update({
                    where: { id: existingAdoption.animalid },
                    data: { status: 'adopted' }
                })

                // Rejeter automatiquement toutes les autres demandes pending pour cet animal
                await tx.adopt.updateMany({
                    where: {
                        animalid: existingAdoption.animalid,
                        id: { not: adoptionId },
                        status: 'pending'
                    },
                    data: { 
                        status: 'rejected',
                        user: 'RejetÃ© automatiquement - animal adoptÃ© par un autre utilisateur'
                    }
                })
            }

            // Si rejetÃ© et que l'animal Ã©tait en pending, le remettre disponible
            if (status === 'rejected' && existingAdoption.animal.status === 'pending') {
                // VÃ©rifier s'il n'y a plus d'autres demandes pending pour cet animal
                const otherPendingAdoptions = await tx.adopt.count({
                    where: {
                        animalid: existingAdoption.animalid,
                        id: { not: adoptionId },
                        status: 'pending'
                    }
                })

                // Si plus de demandes pending, remettre l'animal disponible
                if (otherPendingAdoptions === 0) {
                    await tx.animal.update({
                        where: { id: existingAdoption.animalid },
                        data: { status: 'available' }
                    })
                }
            }

            return updatedAdoption
        })

        res.json({
            success: true,
            message: `Demande d'adoption ${status === 'approved' ? 'approuvÃ©e' : status === 'rejected' ? 'rejetÃ©e' : 'mise Ã  jour'} avec succÃ¨s`,
            data: result
        })

    } catch (error) {
        console.error('Erreur lors de la mise Ã  jour de l\'adoption:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la mise Ã  jour de la demande d\'adoption',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Statistiques des adoptions
ResponsabilitÃ© : Fournir les statistiques pour le dashboard admin
Compte par statut et donnÃ©es rÃ©centes*/

router.get('/admin/adoptions/stats', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        // Compter les adoptions par statut
        const totalAdoptions = await prisma.adopt.count()
        
        const pendingAdoptions = await prisma.adopt.count({
            where: { status: 'pending' }
        })
        
        const approvedAdoptions = await prisma.adopt.count({
            where: { status: 'approved' }
        })
        
        const rejectedAdoptions = await prisma.adopt.count({
            where: { status: 'rejected' }
        })

        // Adoptions ce mois
        const startOfMonth = new Date()
        startOfMonth.setDate(1)
        startOfMonth.setHours(0, 0, 0, 0)

        const adoptionsThisMonth = await prisma.adopt.count({
            where: {
                createdAt: {
                    gte: startOfMonth
                }
            }
        })

        // Adoptions rÃ©centes avec dÃ©tails
        const recentAdoptions = await prisma.adopt.findMany({
            take: 10,
            orderBy: {
                createdAt: 'desc'
            },
            include: {
                users: {
                    select: {
                        firstname: true,
                        lastname: true,
                        email: true
                    }
                },
                animal: {
                    select: {
                        name: true,
                        type: true,
                        breed: true
                    }
                }
            }
        })

        res.json({
            success: true,
            message: 'Statistiques des adoptions rÃ©cupÃ©rÃ©es avec succÃ¨s',
            data: {
                total: totalAdoptions,
                pending: pendingAdoptions,
                approved: approvedAdoptions,
                rejected: rejectedAdoptions,
                thisMonth: adoptionsThisMonth,
                recent: recentAdoptions
            }
        })

    } catch (error) {
        console.error('Erreur lors de la rÃ©cupÃ©ration des statistiques d\'adoption:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la rÃ©cupÃ©ration des statistiques',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

/* ðŸ”’ ROUTE PROTÃ‰GÃ‰E ADMIN - Supprimer une demande d'adoption
ResponsabilitÃ© : Permettre aux administrateurs de supprimer complÃ¨tement une demande
UtilisÃ© pour nettoyer les anciennes demandes ou en cas d'erreur*/

router.delete('/admin/adoptions/:id', authMiddleware, requireAdmin, async (req: Request, res: Response) => {
    try {
        const adoptionId = parseInt(req.params.id)

        if (isNaN(adoptionId)) {
            return res.status(400).json({
                success: false,
                message: 'ID de demande d\'adoption invalide'
            })
        }

        // VÃ©rifier que la demande existe
        const existingAdoption = await prisma.adopt.findUnique({
            where: { id: adoptionId }
        })

        if (!existingAdoption) {
            return res.status(404).json({
                success: false,
                message: 'Demande d\'adoption non trouvÃ©e'
            })
        }

        // Supprimer la demande
        await prisma.adopt.delete({
            where: { id: adoptionId }
        })

        res.json({
            success: true,
            message: 'Demande d\'adoption supprimÃ©e avec succÃ¨s'
        })

    } catch (error) {
        console.error('Erreur lors de la suppression de l\'adoption:', error)

        res.status(500).json({
            success: false,
            message: 'Erreur lors de la suppression de la demande d\'adoption',
            error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined
        })
    }
})

export default router